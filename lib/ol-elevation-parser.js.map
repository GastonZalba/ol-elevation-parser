{"version":3,"file":"ol-elevation-parser.js","sources":["../src/tiles.ts","../src/helpers.ts","../src/logger.ts","../src/defaults.ts","../src/ol-elevation-parser.ts"],"sourcesContent":["import Geometry from 'ol/geom/Geometry';\nimport VectorSource from 'ol/source/Vector';\nimport { getUid } from 'ol/util';\nimport TileImage from 'ol/source/TileImage';\n\nlet tiles: { [key: string]: HTMLImageElement } = {};\n\nexport const addTile = (tileKey: string, tile: HTMLImageElement) => {\n    tiles[tileKey] = tile;\n};\n\nexport const getTile = (key: string) => {\n    return tiles[key];\n};\n\nexport const getTiles = () => {\n    return tiles;\n};\n\nexport const cleanTiles = () => {\n    tiles = {};\n};\n\nexport const getTileKey = (\n    source: TileImage | VectorSource<Geometry>,\n    tileCoord: number[]\n) => {\n    const uidSource = getUid(source);\n    return uidSource + '_' + tileCoord.join('-');\n};\n","/**\n *\n * @param target\n * @param sources\n * @returns\n */\nexport const deepObjectAssign = (target, ...sources) => {\n    sources.forEach((source) => {\n        Object.keys(source).forEach((key) => {\n            const s_val = source[key];\n            const t_val = target[key];\n            target[key] =\n                t_val &&\n                s_val &&\n                typeof t_val === 'object' &&\n                typeof s_val === 'object' &&\n                !Array.isArray(t_val) // Don't merge arrays\n                    ? deepObjectAssign(t_val, s_val)\n                    : s_val;\n        });\n    });\n    return target;\n};\n","export let loggerIsEnabled = false;\n\nexport const setLoggerActive = (bool: boolean) => {\n    loggerIsEnabled = bool;\n};\n\nexport default function logger(...args) {\n    if (loggerIsEnabled) console.log(...args);\n}\n","import { IOptions } from './ol-elevation-parser';\nimport { loggerIsEnabled } from './logger';\n\nconst options: IOptions = {\n    source: null,\n    calculateZMethod: 'getFeatureInfo',\n    samples: 50,\n    noDataValue: -10000,\n    verbose: loggerIsEnabled\n};\n\nexport default options;\n","import LineString from 'ol/geom/LineString';\nimport Point from 'ol/geom/Point';\nimport Control, { Options as ControlOptions } from 'ol/control/Control';\nimport { PluggableMap } from 'ol';\nimport TileImage from 'ol/source/TileImage';\nimport TileGrid from 'ol/tilegrid/TileGrid';\nimport {\n    createXYZ,\n    getForProjection as getTileGridForProjection\n} from 'ol/tilegrid';\nimport TileWMS from 'ol/source/TileWMS';\nimport XYZ from 'ol/source/XYZ';\nimport View from 'ol/View';\nimport { Coordinate } from 'ol/coordinate';\nimport Feature from 'ol/Feature';\n\nimport axios from 'axios';\n\nimport { addTile, cleanTiles, getTile, getTileKey } from './tiles';\nimport { deepObjectAssign } from './helpers';\nimport defaultOptions from './defaults';\nimport logger, { setLoggerActive } from './logger';\n\nconst AXIOS_TIMEOUT = 5000;\n\nexport * from './tiles';\n\n/**\n * @extends {ol/control/Control~Control}\n * @fires change:samples\n * @fires change:source\n * @fires change:calculateZMethod\n * @param opt_options\n */\nexport default class ElevationParser extends Control {\n    protected _map: PluggableMap;\n    protected _countConnections = 0;\n\n    constructor(options: IOptions) {\n        super({});\n\n        const _options: IOptions = deepObjectAssign(defaultOptions, options);\n\n        setLoggerActive(_options.verbose);\n\n        this._addPropertyEvents();\n\n        this.set('source', _options.source, /* silent = */ false);\n        this.set('samples', _options.samples, /* silent = */ true);\n        this.set(\n            'calculateZMethod',\n            _options.calculateZMethod,\n            /* silent = */ true\n        );\n        this.set('noDataValue', _options.noDataValue, /* silent = */ true);\n    }\n\n    /**\n     * @public\n     * @param source\n     */\n    setSource(source: IOptions['source']): void {\n        this.set('source', source);\n    }\n\n    /**\n     * @public\n     * @param samples\n     */\n    setSamples(samples: IOptions['samples']): void {\n        this.set('samples', samples);\n    }\n\n    /**\n     * @public\n     * @param calculateZMethod\n     */\n    setCalculateZMethod(calculateZMethod: IOptions['calculateZMethod']): void {\n        this.set('calculateZMethod', calculateZMethod);\n    }\n\n    /**\n     * @public\n     * @param noDataValue\n     */\n    setNoDataValue(noDataValue: IOptions['noDataValue']): void {\n        this.set('noDataValue', noDataValue);\n    }\n\n    /**\n     *\n     * @param coords\n     * @returns\n     * @public\n     */\n    async requestZValues(\n        originalFeature: Feature<LineString | Point>\n    ): Promise<{ coordsWithZ: number[]; zValues: number[] }> {\n        const coords = this._sampleFeatureCoords(originalFeature);\n\n        let coordsWithZ = [];\n        const zValues: number[] = [];\n\n        const source = this.get('source');\n\n        if (typeof source === 'function') {\n            // Use a custom function\n            coordsWithZ = await source(originalFeature, coords);\n        } else {\n            this._countConnections++;\n            const countConnections = this._countConnections;\n            let errorCount = 0;\n\n            for (const coord of coords) {\n                try {\n                    // If there is a new connection (onChange event), abort this\n                    if (this._countConnections !== countConnections) {\n                        logger(\n                            'New geometry detected, previous requests aborted'\n                        );\n                        return;\n                    }\n\n                    let zValue: number;\n\n                    if (\n                        source instanceof TileWMS &&\n                        this.get('calculateZMethod') === 'getFeatureInfo'\n                    ) {\n                        zValue = await this._getZValuesFromWMS(\n                            coord,\n                            source,\n                            this._map.getView()\n                        );\n                    } else {\n                        zValue = await this._getZValuesFromImage(coord, source);\n                    }\n\n                    if (this.get('noDataValue') !== false) {\n                        zValue =\n                            zValue === this.get('noDataValue') ? 0 : zValue;\n                    }\n\n                    // If null or undefined value is returned, transform to 0\n                    const zValueRound =\n                        typeof zValue !== 'undefined'\n                            ? Number(zValue.toFixed(3))\n                            : 0;\n\n                    coordsWithZ.push([...coord, zValueRound]);\n                    zValues.push(zValueRound);\n                } catch (err) {\n                    errorCount++;\n                    console.error(err);\n                    if (errorCount >= 5) {\n                        throw err;\n                    }\n                }\n            }\n        }\n        return { coordsWithZ, zValues };\n    }\n\n    /**\n     * @protected\n     */\n    _addPropertyEvents(): void {\n        // @ts-expect-error\n        this.on('change:source', (evt: ObjectEvent) => {\n            const source = evt.target.get(evt.key);\n            cleanTiles();\n            if (source instanceof TileImage) {\n                // This is useful if the source is aready visible on the map,\n                // and some tiles are already downloaded outside this module\n                source.on('tileloadend', ({ tile }) => {\n                    const tileCoord = tile.tileCoord;\n                    const tileKey = getTileKey(source, tileCoord);\n                    addTile(\n                        tileKey,\n                        // @ts-expect-error\n                        tile.getImage()\n                    );\n                });\n            }\n        });\n    }\n\n    /**\n     * Get some sample coords from the geometry while preserving the vertices.\n     * Each of these coords whill be used to request getFeatureInfo\n     * @protected\n     */\n    _sampleFeatureCoords(\n        drawFeature: Feature<LineString | Point>\n    ): Coordinate[] {\n        const geom = drawFeature.getGeometry();\n\n        if (geom instanceof Point) return [geom.getCoordinates()];\n\n        const stepPercentage = 100 / this.get('samples');\n\n        const totalLength = geom.getLength();\n\n        const metersSample = totalLength * (stepPercentage / 100);\n\n        logger('Total length', totalLength);\n        logger(`Samples every ${metersSample.toFixed(2)} meters`);\n\n        const sampledCoords: Coordinate[] = [];\n        let segmentCount = 0;\n\n        // Get samples every percentage step while conserving all the vertex\n        geom.forEachSegment((start, end) => {\n            // Only get the first start segment\n            if (!segmentCount) {\n                sampledCoords.push(start);\n            }\n\n            segmentCount++;\n\n            const segmentGeom = new LineString([start, end]);\n            const segmentLength = segmentGeom.getLength();\n\n            /**\n             * segmentLength -> 100\n             * metersSample -> x\n             */\n            const newPercentage = (100 * metersSample) / segmentLength;\n\n            // skip 0 and 100\n            let segmentStepPercent = newPercentage;\n            while (segmentStepPercent < 100) {\n                const coordAt = segmentGeom.getCoordinateAt(\n                    segmentStepPercent / 100\n                );\n                sampledCoords.push(coordAt);\n                segmentStepPercent = segmentStepPercent + newPercentage;\n            }\n\n            sampledCoords.push(end);\n        });\n\n        logger('Vertices', sampledCoords.length);\n        logger('Segments', segmentCount);\n\n        return sampledCoords;\n    }\n\n    /**\n     *\n     * @param coordinate\n     * @param source\n     * @returns\n     */\n    async _getZValuesFromImage(\n        coordinate: Coordinate,\n        source: TileImage | XYZ\n    ): Promise<number> {\n        const addSrcToImage = (\n            img: HTMLImageElement,\n            src: string\n        ): Promise<any> => {\n            return new Promise((resolve, reject) => {\n                img.onload = () => resolve(img.height);\n                img.onerror = reject;\n                img.src = src;\n            });\n        };\n\n        let tilegrid = source.getTileGrid();\n\n        // If not tileGrid is provided, set a default for XYZ sources\n        if (!tilegrid) {\n            if (source instanceof XYZ) {\n                const defaultTileGrid = createXYZ();\n                tilegrid = new TileGrid({\n                    origin: defaultTileGrid.getOrigin(0),\n                    resolutions: defaultTileGrid.getResolutions()\n                });\n            } else {\n                tilegrid = getTileGridForProjection(\n                    this._map.getView().getProjection()\n                );\n            }\n        }\n\n        const tileCoord = tilegrid.getTileCoordForCoordAndResolution(\n            coordinate,\n            this._map.getView().getResolution()\n        );\n\n        const urlFn = source.getTileUrlFunction();\n\n        const projection =\n            source.getProjection() || this._map.getView().getProjection();\n\n        const url = urlFn(tileCoord, 1, projection);\n\n        const tileKey = getTileKey(this.get('source'), tileCoord);\n\n        let imageTile = getTile(tileKey);\n\n        // Check if the image was already downloaded\n        if (!getTile(tileKey)) {\n            const { data } = await axios.get(url, {\n                timeout: AXIOS_TIMEOUT,\n                responseType: 'blob'\n            });\n            const urlCreator = window.URL || window.webkitURL;\n            const imageSrc = urlCreator.createObjectURL(data);\n            const imageElement = new Image();\n            await addSrcToImage(imageElement, imageSrc);\n            addTile(tileKey, imageElement);\n            imageTile = imageElement;\n        }\n\n        const origin = tilegrid.getOrigin(tileCoord[0]);\n        const res = tilegrid.getResolution(tileCoord[0]);\n        const tileSize = tilegrid.getTileSize(tileCoord[0]);\n        const w = Math.floor(\n            ((coordinate[0] - origin[0]) / res) %\n                (tileSize[0] | (tileSize as number))\n        );\n        const h = Math.floor(\n            ((origin[1] - coordinate[1]) / res) %\n                (tileSize[1] | (tileSize as number))\n        );\n\n        const canvas = document.createElement('canvas');\n        canvas.width = imageTile.width;\n        canvas.height = imageTile.height;\n\n        // Add image to a canvas\n        const ctx = canvas.getContext('2d');\n        ctx.drawImage(imageTile, 0, 0);\n\n        const img = ctx.getImageData(0, 0, canvas.width, canvas.height);\n        const imgData = img.data;\n        const index = (w + h * 256) * 4;\n        const pixel = [\n            imgData[index + 0],\n            imgData[index + 1],\n            imgData[index + 2],\n            imgData[index + 3]\n        ];\n\n        return this._extractValuesFromPixelDEM(pixel);\n    }\n\n    /**\n     *\n     * @param coordinate\n     * @param source\n     * @param view\n     * @returns\n     */\n    async _getZValuesFromWMS(\n        coordinate: Coordinate,\n        source: TileWMS,\n        view: View\n    ): Promise<number> {\n        const url = source.getFeatureInfoUrl(\n            coordinate,\n            view.getResolution(),\n            view.getProjection(),\n            {\n                INFO_FORMAT: 'application/json',\n                BUFFER: 0,\n                FEATURE_COUNT: 1\n            }\n        );\n\n        const { data } = await axios.get(url, {\n            timeout: AXIOS_TIMEOUT\n        });\n\n        return data.features[0].properties.GRAY_INDEX;\n    }\n\n    /**\n     * @protected\n     * @param pixel\n     * @returns\n     */\n    _extractValuesFromPixelDEM(pixel: number[]): number {\n        const mapboxExtractElevation = (\n            r: number,\n            g: number,\n            b: number\n        ): number => {\n            return (r * 256 * 256 + g * 256 + b) * 0.1 - 10000;\n        };\n\n        const terrariumExtractElevation = (\n            r: number,\n            g: number,\n            b: number\n        ): number => {\n            return r * 256 + g + b / 256 - 32768;\n        };\n\n        const calculateZMethod = this.get('calculateZMethod');\n\n        if (calculateZMethod && typeof calculateZMethod === 'function') {\n            return calculateZMethod(pixel[0], pixel[1], pixel[2]);\n        } else if (calculateZMethod === 'Mapbox') {\n            return mapboxExtractElevation(pixel[0], pixel[1], pixel[2]);\n        } else if (calculateZMethod === 'Terrarium') {\n            return terrariumExtractElevation(pixel[0], pixel[1], pixel[2]);\n        }\n    }\n}\n\nexport interface IOptions extends Omit<ControlOptions, 'target'> {\n    /**\n     * Source to obtain the elevation values.\n     * If not provided, the zGraph would be not displayed.\n     * You can provide a custom function to call an API or other methods to obtain the data.\n     */\n    source?:\n        | TileWMS\n        | TileImage\n        | XYZ\n        | ((\n              originalFeature: Feature<LineString | Point>,\n              sampledCoords: Coordinate[]\n          ) => Promise<Coordinate[]>);\n\n    /**\n     * To obtain the elevation values from the diferrents sources, you can:\n     * - Calculate the zValues from the rgb pixel data (`TileImage` and `XYZ` source formats need this):\n     *     - `Mapbox` preset: (r * 256 * 256 + g * 256 + b) * 0.1 - 10000\n     *     - `Terrarium` preset: (r * 256 + g + b / 256) - 32768\n     *     - Provided your custom function to calculate elevation from the rgb pixel data\n     *\n     * - Making requests to the geoserver (`TileWMS` source)\n     *      `getFeatureInfo`: make requests to the source url using service [getFeatureInfo](https://docs.geoserver.org/stable/en/user/services/wms/reference.html#getfeatureinfo)\n     *\n     * By default:\n     *  - `TileWMS` format use `'getFeatureInfo'` requests to the source_url to obtain the values.\n     *  - `TileImage` and `XYZ` formats are calculated from the pixel data using `'Mapbox'` preset.\n     */\n    calculateZMethod?:\n        | 'getFeatureInfo'\n        | 'Mapbox'\n        | 'Terrarium'\n        | ((r: number, g: number, b: number) => number);\n\n    /**\n     * To obtain the elevation values on each distance measurement, multiples samples are taken across the line.\n     * This number is used as equally percentage steps across the geom, plus all the vertices positions.\n     * - `getFeatureInfo` on TileWMS sources will make one request per sample\n     * - `TileImage`and `XYZ` are calculated across each pixel after downloading the required tiles.\n     * The bigger the number, the greater the quality of the elevation data, but slower response times and\n     * bigger overhead (principally on `getFeatureInfo` method).\n     * `50` is the default\n     *\n     */\n    samples?: number;\n\n    /**\n     * When calculating the zGraph statistics from the raster dataset, you can choose to ignore specific values with the NoDataValue parameter.\n     * These values are considerated as transparency, so probably you want these replaced by 0.\n     *\n     * `-10000` is the default\n     * `false` to disable\n     */\n    noDataValue?: number | false;\n\n    /**\n     * console.log to help debug the code\n     * `false` is the default\n     */\n    verbose?: boolean;\n}\n"],"names":["options","defaultOptions","getTileGridForProjection"],"mappings":"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"}