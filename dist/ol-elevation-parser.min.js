/*!
 * ol-elevation-parser - v1.3.20
 * https://github.com/GastonZalba/ol-elevation-parser#readme
 * Built: Wed Aug 13 2025 14:19:24 GMT-0300 (hora estÃ¡ndar de Argentina)
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("ol/geom/LineString.js"),require("ol/geom/Point.js"),require("ol/geom/Polygon.js"),require("ol/control/Control.js"),require("ol/source/TileWMS.js"),require("@turf/bbox"),require("@turf/area"),require("@turf/intersect"),require("@turf/helpers"),require("@turf/square-grid"),require("ol/format/GeoJSON.js"),require("ol/tilegrid.js"),require("ol/tilegrid/TileGrid.js"),require("ol/source/XYZ.js"),require("ol/DataTile.js"),require("ol/ImageTile.js")):"function"==typeof define&&define.amd?define(["ol/geom/LineString.js","ol/geom/Point.js","ol/geom/Polygon.js","ol/control/Control.js","ol/source/TileWMS.js","@turf/bbox","@turf/area","@turf/intersect","@turf/helpers","@turf/square-grid","ol/format/GeoJSON.js","ol/tilegrid.js","ol/tilegrid/TileGrid.js","ol/source/XYZ.js","ol/DataTile.js","ol/ImageTile.js"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).ElevationParser=t(e.ol.geom.LineString,e.ol.geom.Point,e.ol.geom.Polygon,e.ol.control.Control,e.ol.source.TileWMS,e["@turf/bbox"],e["@turf/area"],e["@turf/intersect"],e["@turf/helpers"],e["@turf/square-grid"],e.ol.format.GeoJSON,e.ol.tilegrid,e.ol.tilegrid.TileGrid,e.ol.source.XYZ,e.ol.DataTile,e.ol.ImageTile)}(this,(function(e,t,o,s,i,r,n,a,l,u,c,h,g,d,m,p){"use strict";function f(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var _=f((function(e,t,o=(e=>e),s){const i=o,r=[];for(let o=0;o<e.length;o+=1){const n=o-t,a=o+t+1;let l=0,u=0;for(let t=n>=0?n:0;t<a&&t<e.length;t+=1)u+=i(e[t]),l+=1;r[o]=s?s(e[o],u/l):u/l}return r}));const S=new c,M=(e,...t)=>(t.forEach((t=>{Object.keys(t).forEach((o=>{const s=t[o],i=e[o];e[o]=i&&s&&"object"==typeof i&&"object"==typeof s&&!Array.isArray(i)?M(i,s):s}))})),e),j=(t,o)=>{const s=t.getLength();"function"==typeof o&&(o=o(s));const i=s*(100/o/100),r=[];let n=0;return t.forEachSegment(((t,o)=>{n||r.push([t[0],t[1]]),n++;const s=new e([[t[0],t[1]],[o[0],o[1]]]),a=s.getLength(),l=100*i/a;let u=l;for(;u<100;){const e=s.getCoordinateAt(u/100);r.push(e),u+=l}r.push([o[0],o[1]])})),r};let y=!1;function v(...e){y&&console.log(...e)}const b={source:null,calculateZMethod:"getFeatureInfo",tilesResolution:"current",bands:4,samples:50,smooth:0,sampleSizeArea:"auto",noDataValue:-1e4,timeout:5e3,verbose:y};class C{constructor(e,t,o,s){this._projection=e.getProjection()||s.getView().getProjection(),this._view=s.getView(),this._source=e,this._bands=o,this._calculateZMethod=t,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d")}async read(e,t){this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);const o=this._getTileGrid(),s=o.getTileCoordForCoordAndResolution(e,t),i=s[0],r=o.getTileSize(i),n=this._source.getTile(s[0],s[1],s[2],1,this._projection);let a;if(2!==n.getState()&&await new Promise((e=>{const t=()=>{2===n.getState()?(n.removeEventListener("change",t),e(null)):3===n.getState()&&e(null)};n.addEventListener("change",t),n.load()})),n instanceof m?a=n.getData():n instanceof p&&(a=n.getImage()),!a)return;const l=a.width||r[0]||r,u=a.height||r[1]||r;let c;this._canvas.width=l,this._canvas.height=u,this._ctx.mozImageSmoothingEnabled=!1,this._ctx.oImageSmoothingEnabled=!1,this._ctx.webkitImageSmoothingEnabled=!1,this._ctx.msImageSmoothingEnabled=!1,this._ctx.imageSmoothingEnabled=!1,a instanceof HTMLImageElement?(this._ctx.drawImage(a,0,0),c=this._ctx.getImageData(0,0,l,u)):(c=this._ctx.createImageData(l,u),c.data.set(a));const h=o.getOrigin(i),g=o.getResolution(i),d=Math.floor((e[0]-h[0])/g%l),f=Math.floor((h[1]-e[1])/g%u),_=c.data,S=(d+f*l)*this._bands,M=[_[S+0],_[S+1],_[S+2],_[S+3]];return this._extractValuesFromPixelDEM(M)}getMaxResolution(){const e=this._getTileGrid().getMaxZoom();return e?this._getTileGrid().getResolution(e):null}_getTileGrid(){let e=this._source.getTileGrid();if(!e)if(this._source instanceof d){const t=h.createXYZ();e=new g({origin:t.getOrigin(0),resolutions:t.getResolutions()})}else e=h.getForProjection(this._projection);return e}_extractValuesFromPixelDEM(e){return this._calculateZMethod&&"function"==typeof this._calculateZMethod?this._calculateZMethod(e[0],e[1],e[2]):"Mapbox"===this._calculateZMethod?(t=e[0],o=e[1],s=e[2],.1*(256*t*256+256*o+s)-1e4):"Terrarium"===this._calculateZMethod?((e,t,o)=>256*e+t+o/256-32768)(e[0],e[1],e[2]):void 0;var t,o,s}}class T extends s{constructor(e){var t;super({element:document.createElement("div")}),this._countConnections=0,this._rasterSourceIsLoaded=!1,this._initialized=!1,this._getZFromSampledCoords=async(e,t=null)=>{this._countConnections++;const o=this._countConnections;let s=0;const r=[],n=this.get("source"),a=e.length>=5?1:5;let l;const u=(null==t?void 0:t.tilesResolution)||this.getTilesResolution();if("current"===u)l=this.getMap().getView().getResolution(),l||console.warn("Cannot calculate current view resolution");else if("max"===u){const e=this.getMaxTilesResolution();e?l=e:console.warn("Cannot calculate source's max resolution")}else l=u;l||(l=this.getMap().getView().getMinResolution()||.01,console.warn("Using fallback resolution:",l));for(const t of e)try{if(this._countConnections!==o)return v("New geometry detected, previous requests aborted"),null;let e;e=n instanceof i&&"getFeatureInfo"===this.get("calculateZMethod")?await this._getZValuesFromWMS(t,n,this.getMap().getView()):await this._getZValuesFromImage(t,l),!1!==this.get("noDataValue")&&(e=e===this.get("noDataValue")?void 0:e);const s="Terrarium"===this.get("calculateZMethod")?-32768:void 0,a=void 0!==e&&e!==s?Number(e.toFixed(3)):void 0;r.push([...t,a])}catch(e){if(s++,console.error(e),s>=a)throw e}return r},this._options=M({},b,e),this._options.source instanceof i||"getFeatureInfo"!==this._options.calculateZMethod||(this._options.calculateZMethod="Mapbox"),t=this._options.verbose,y=t}async getElevationValues(e,t=null){try{const o=()=>new Promise(((e,t)=>{const o=(s=0,i=5,r=500)=>{"ready"!==a.getState()?++s>i?t():setTimeout((()=>o(s++)),r):e(null)};o()})),{sampledCoords:s,gridPolygons:i}=this._sampleFeatureCoords(e,t);let r,n;const a=this.get("source");if("function"==typeof a?({mainCoords:n,contourCoords:r}=await a(e,s)):(this._rasterSourceIsLoaded||(await o(),this._rasterSourceIsLoaded=!0),n=await this._getZFromSampledCoords(s.mainCoords,t),n&&s.contourCoords&&(r=await this._getZFromSampledCoords(s.contourCoords,t))),null===n)return null;const l=(null==t?void 0:t.smooth)||this.get("smooth");return l&&(n=((e,t=0)=>{const o=(e=[...e]).map((e=>e[2])),s=_(o,t);return e.map(((e,t)=>(e[2]=s[t],e)))})(n,l)),Object.assign(Object.assign({mainCoords:n},r&&{contourCoords:r}),i&&{gridPolygons:i})}catch(e){return this.dispatchEvent("error"),e}}getSource(){return this.get("source")}setSource(e,t=!1){this.set("source",e,t)}getSamples(){return this.get("samples")}setSamples(e,t=!1){this.set("samples",e,t)}getSampleSizeArea(){return this.get("sampleSizeArea")}setSampleSizeArea(e,t){this.set("sampleSizeArea",e,t)}getCalculateZMethod(){return this.get("calculateZMethod")}setCalculateZMethod(e,t=!1){this.set("calculateZMethod",e,t)}getSmooth(){return this.get("smooth")}setSmooth(e,t=!1){this.set("smooth",e,t)}getNoDataValue(){return this.get("noDataValue")}setNoDataValue(e,t=!1){this.set("noDataValue",e,t)}getTilesResolution(){return this.get("tilesResolution")}setTilesResolution(e,t=!1){this.set("tilesResolution",e,t)}getBands(){return this.get("bands")}setBands(e,t=!1){this.set("bands",e,t)}getTimeout(){return this.get("timeout")}setTimeout(e,t=!1){this.set("timeout",e,t)}getMaxTilesResolution(){return this._readFromImage?this._readFromImage.getMaxResolution():null}getCurrentViewResolution(){return this.getMap().getView().getResolution()}setMap(e){super.setMap(e),e&&(this._initialized||this._init())}_init(){this.setSamples(this._options.samples,!0),this.setSampleSizeArea(this._options.sampleSizeArea,!0),this.setCalculateZMethod(this._options.calculateZMethod,!0),this.setNoDataValue(this._options.noDataValue,!0),this.setSmooth(this._options.smooth,!0),this.setTilesResolution(this._options.tilesResolution,!0),this.setBands(this._options.bands,!0),this.setTimeout(this._options.timeout,!0),this.setSource(this._options.source,!0),this._addPropertyEvents(),this._onInitModifySource(),this._initialized=!0,this.dispatchEvent(w.LOAD)}_addPropertyEvents(){this.on(["change:source","change:bands","change:calculateZMethod"],(()=>{this._onInitModifySource()}))}_onInitModifySource(){const e=this.getSource();e instanceof Function||"getFeatureInfo"===this.get("calculateZMethod")?this._readFromImage=null:this._readFromImage=new C(e,this.get("calculateZMethod"),this.get("bands"),this.getMap())}_sampleFeatureCoords(s,i){const c=s.getGeometry();let h,g,d;const m={samples:(null==i?void 0:i.samples)||this.getSamples(),sampleSizeArea:(null==i?void 0:i.sampleSizeArea)||this.getSampleSizeArea()};if(c instanceof t)d=[[c.getCoordinates()[0],c.getCoordinates()[1]]];else if(c instanceof o){const t=s,o=t.getGeometry().getCoordinates()[0],i=new e([o[0],o[1]]);g=j(i,m.samples),h=((e,t,o)=>{const s=S.writeFeatureObject(e,{dataProjection:"EPSG:4326",featureProjection:t}),i=n(s.geometry);let c;"auto"!==o?"number"==typeof o?c=o:"function"==typeof o&&(c=o(i)):c=i<=1e3?.5:i<1e4?1:i<1e5?10:i<1e6?50:100;const h=r(s);let g=u(h,c/1e3,{units:"kilometers",mask:s.geometry}).features.map((e=>a(e.geometry,s)));g=g.filter((e=>e));const d=l.featureCollection(g);return S.readFeatures(d,{dataProjection:"EPSG:4326",featureProjection:t})})(t,this.getMap().getView().getProjection().getCode(),m.sampleSizeArea),d=h.map((e=>{const t=e.getGeometry().getInteriorPoint().getCoordinates();return[t[0],t[1]]}))}else c instanceof e&&(d=j(c,m.samples));return{sampledCoords:{mainCoords:d,contourCoords:g},gridPolygons:h}}async _getZValuesFromImage(e,t){return await this._readFromImage.read(e,t)}async _getZValuesFromWMS(e,t,o){var s,i;const r=t.getFeatureInfoUrl(e,o.getResolution(),o.getProjection(),{INFO_FORMAT:"application/json",BUFFER:0,FEATURE_COUNT:1}),n=await fetch(r,{signal:AbortSignal.timeout(this.getTimeout())});return null===(i=null===(s=(await n.json()).features[0])||void 0===s?void 0:s.properties)||void 0===i?void 0:i.GRAY_INDEX}}var w;!function(e){e.LOAD="load"}(w||(w={}));var I=Object.freeze({__proto__:null,get GeneralEventTypes(){return w},default:T});return Object.assign(T,I),T}));
//# sourceMappingURL=ol-elevation-parser.min.js.map
