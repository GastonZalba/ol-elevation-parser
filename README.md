# OpenLayers Elevation Parser

Sample Features and retrieve parsed elevation data from Open Layers sources (TileWMS, TileImage, XYZ), using raster grayscale (float) or rgb (Terrarium, Mapbox or custom processings) elevation models.

Tested with OpenLayers version 6.

## Usage

```js
import ElevationParser from 'ol-elevation-parser';

import TileWMS from 'ol/source/TileWMS';
import LineString from 'ol/geom/LineString';
import Feature from 'ol/Feature';

var elevationLayer = new TileWMS({
    url: 'http://localhost:8080/geoserver/dipsohdev/ows',
    serverType: 'geoserver',
    crossOrigin: null,
    interpolate: false,
    params: {
        SERVICE: 'wms',
        LAYERS: 'mdeIgnRgb'
    }
});

var options = {
    source: elevationLayer,
    calculateZMethod: 'getFeatureInfo',
    samples: 50,
    sampleSizeArea: 'auto', // For polygons area
    noDataValue: -10000
};

var elevationParser = new ElevationParser(options);

// Add control the the Open Layers map instance
map.addControl(elevationParser);

var lineStringFeature = new Feature(new LineString(/*...*/));

const data = await elevationParser.requestZValues(feature);
```

## Changelog

See CHANGELOG for details of changes in each release.

## Install

### Parcel, Webpack, etc.

NPM package: [ol-elevation-parser](https://www.npmjs.com/package/ol-elevation-parser).

Install the package via `npm`

    npm install ol-elevation-parser --save-dev

#### JS

```js
import ElevationParser from 'ol-elevation-parser';
```

##### TypeScript type definition

TypeScript types are shipped with the project in the dist directory and should be automatically used in a TypeScript project. Interfaces are provided for the Options.

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

#### Table of Contents

-   [ElevationParser](#elevationparser)
    -   [Parameters](#parameters)
    -   [requestZValues](#requestzvalues)
        -   [Parameters](#parameters-1)
    -   [setSource](#setsource)
        -   [Parameters](#parameters-2)
    -   [setSamples](#setsamples)
        -   [Parameters](#parameters-3)
    -   [setSampleSizeArea](#setsamplesizearea)
        -   [Parameters](#parameters-4)
    -   [setCalculateZMethod](#setcalculatezmethod)
        -   [Parameters](#parameters-5)
    -   [setNoDataValue](#setnodatavalue)
        -   [Parameters](#parameters-6)
-   [IRequestZValues](#irequestzvalues)
    -   [gridPolygons](#gridpolygons)
-   [IElevationCoords](#ielevationcoords)
    -   [mainCoords](#maincoords)
    -   [contourCoords](#contourcoords)
-   [IOptions](#ioptions)
    -   [source](#source)
    -   [calculateZMethod](#calculatezmethod)
    -   [samples](#samples)
    -   [sampleSizeArea](#samplesizearea)
    -   [noDataValue](#nodatavalue)
    -   [verbose](#verbose)

### ElevationParser

**Extends ol/control/Control~Control**

#### Parameters

-   `options` **[IOptions](#ioptions)**

#### requestZValues

##### Parameters

-   `feature` **Feature<(LineString | Point | Polygon)>**

Returns **[Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)<[IRequestZValues](#irequestzvalues)>**

#### setSource

##### Parameters

-   `source` **any**

Returns **void**

#### setSamples

##### Parameters

-   `samples` **any**

Returns **void**

#### setSampleSizeArea

##### Parameters

-   `sampleSizeArea` **any**

Returns **void**

#### setCalculateZMethod

##### Parameters

-   `calculateZMethod` **any**

Returns **void**

#### setNoDataValue

##### Parameters

-   `noDataValue` **any**

Returns **void**

### IRequestZValues

**Extends IElevationCoords**

#### gridPolygons

Sampled Polygons

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)\<Feature\<Polygon>>

### IElevationCoords

#### mainCoords

Sampled coordinates from LineStrings, Point coordinates,
or sampled coordinates from Polygons, obtained by subdividing the area in multiples squares and getting each center point.

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)\<Coordinate>

#### contourCoords

Contour coordinates from Polygons features.

Type: [Array](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Array)\<Coordinate>

### IOptions

**Extends Omit\<ControlOptions, 'target'>**

#### source

Source to obtain the elevation values.
If not provided, the zGraph would be not displayed.
You can provide a custom function to call an API or other methods to obtain the data.

Type: (TileWMS | TileImage | XYZ | function (originalFeature: Feature<(LineString | Point | Polygon)>, sampledCoords: [IElevationCoords](#ielevationcoords)): [Promise](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Promise)<[IElevationCoords](#ielevationcoords)>)

#### calculateZMethod

To obtain the elevation values from the diferrents sources, you can:

-   Calculate the zValues from the rgb pixel data (`TileImage` and `XYZ` source formats need this):

    -   `Mapbox` preset: (r \* 256 \* 256 + g \* 256 + b) \* 0.1 - 10000
    -   `Terrarium` preset: (r \* 256 + g + b / 256) - 32768
    -   Provided your custom function to calculate elevation from the rgb pixel data

-   Making requests to the geoserver (`TileWMS` source)
    `getFeatureInfo`: make requests to the source url using service [getFeatureInfo](https://docs.geoserver.org/stable/en/user/services/wms/reference.html#getfeatureinfo)

By default:

-   `TileWMS` format use `'getFeatureInfo'` requests to the source_url to obtain the values.
-   `TileImage` and `XYZ` formats are calculated from the pixel data using `'Mapbox'` preset.

Type: (`"getFeatureInfo"` | `"Mapbox"` | `"Terrarium"` | function (r: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number), g: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number), b: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)): [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number))

#### samples

To obtain the elevation values on each distance measurement, multiples samples are taken across the line.
This number is used as equally percentage steps across the geom, plus all the vertices positions.

-   `getFeatureInfo` on TileWMS sources will make one request per sample
-   `TileImage`and `XYZ` are calculated across each pixel after downloading the required tiles.

The bigger the number, the greater the quality of the elevation data, but slower response times and
bigger overhead (principally on `getFeatureInfo` method).
`50` is the default

Type: [number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number)

#### sampleSizeArea

To obtain the elevation values on each volume measurement, multiples samples are taken across the polygon.
Value in meters
The bigger the number, the greater the quality of the measurement, but slower response times and
bigger overhead (principally on `getFeatureInfo` method).
`'auto'` is the default. This use 0.5 on small measurements, and 10 in biggers ones

Type: ([number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number) | `"auto"`)

#### noDataValue

When calculating the zGraph statistics from the raster dataset, you can choose to ignore specific values with the NoDataValue parameter.
These values are considerated as transparency, so probably you want these replaced by 0.

`-10000` is the default
`false` to disable

Type: ([number](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Number) | `false`)

#### verbose

console.log to help debug the code
`false` is the default

Type: [boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)

## TODO

-   Improve README and documentation
-   Add jest

## License

MIT (c) Gast√≥n Zalba.
